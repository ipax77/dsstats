@page "/stats/duration"
@layout StatsLayout
@using pax.dsstats.shared;
@inject NavigationManager NavigationManager

<PageTitle>Stats/Duration</PageTitle>

<sc2dsstats.razorlib.Stats.Duration.DurationComponent Request="Request" OnRequetChanged="RequestChanged"></sc2dsstats.razorlib.Stats.Duration.DurationComponent>

@code {
    [SupplyParameterFromQuery]
    public int? Time { get; set; }
    [SupplyParameterFromQuery]
    public int? Type { get; set; }
    [SupplyParameterFromQuery]
    public int? Brawl { get; set; }
    [SupplyParameterFromQuery]
    public int? Rating { get; set; }

    protected override void OnInitialized()
    {
        SetRequest();
        base.OnInitialized();
    }

    DurationRequest Request = new() 
    {
        TimePeriod = TimePeriod.Patch2_71,
        RatingType = RatingType.Cmdr,
        WithBrawl = false,
        WithRating = true
    };

    private void SetRequest()
    {
        if (Time != null)
        {
            Request.TimePeriod = (TimePeriod)Time.Value;
        }

        if (Type != null)
        {
            Request.RatingType = (RatingType)Type.Value;
        }

        if (Brawl != null)
        {
            Request.WithBrawl = Brawl.Value > 0;
        }

        if (Rating != null)
        {
            Request.WithRating = Rating.Value > 0;
        }
    }

    private void RequestChanged(DurationRequest request)
    {
        Dictionary<string, object?> queryDic = new();

        queryDic.Add("Time", (int)request.TimePeriod);

        if (request.RatingType == RatingType.Std)
        {
            queryDic.Add("Type", (int)request.RatingType);
        }
        else
        {
            queryDic.Add("Type", null);
        }

        if (request.WithBrawl)
        {
            queryDic.Add("Brawl", 1);
        }
        else
        {
            queryDic.Add("Brawl", null);
        }

        if (!request.WithRating)
        {
            queryDic.Add("Rating", 0);
        }
        else
        {
            queryDic.Add("Rating", null);
        }

        NavigationManager.NavigateTo(
        NavigationManager.GetUriWithQueryParameters(
            new Dictionary<string, object?>(queryDic)
        )
        );
    }
}