{"version":3,"file":"backup.js","mappings":"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","sources":["webpack://dsstats10/./Client/db-core.ts","webpack://dsstats10/webpack/bootstrap","webpack://dsstats10/webpack/runtime/define property getters","webpack://dsstats10/webpack/runtime/hasOwnProperty shorthand","webpack://dsstats10/./Client/backup.ts"],"sourcesContent":["import { Dump, Migration } from \"./migration.js\";\r\n\r\nexport const DB_NAME = \"ReplayDB\";\r\nexport const DB_VERSION = 3;\r\n\r\nexport const STORES = {\r\n    replays: \"Replays\",\r\n    lists: \"ReplayLists\",\r\n    meta: \"ReplayMeta\",\r\n    config: \"Config\",\r\n    directoryHandles: \"DirectoryHandles\",\r\n};\r\n\r\nlet db: IDBDatabase | null = null;\r\n\r\nexport function openDB(): Promise<IDBDatabase> {\r\n    return new Promise((resolve, reject) => {\r\n        if (db) {\r\n            resolve(db);\r\n            return;\r\n        }\r\n\r\n        const request = indexedDB.open(DB_NAME, DB_VERSION);\r\n\r\n        request.onupgradeneeded = (event) => {\r\n            const database = (event.target as IDBOpenDBRequest).result;\r\n            const tx = (event.target as IDBOpenDBRequest).transaction!;\r\n            const oldVersion = event.oldVersion;\r\n\r\n            // Apply migrations incrementally\r\n            for (let v = oldVersion; v < DB_VERSION; v++) {\r\n                const migration = upgrades[v];\r\n                if (migration?.schema) {\r\n                    migration.schema(database, tx);\r\n                }\r\n            }\r\n        };\r\n\r\n        request.onsuccess = () => {\r\n            db = request.result;\r\n\r\n            resolve(db);\r\n        };\r\n\r\n        request.onerror = () => reject(request.error);\r\n    });\r\n}\r\n\r\nexport function closeDB(): void {\r\n    if (db) {\r\n        db.close();\r\n        db = null;\r\n    }\r\n}\r\n\r\n\r\nexport function migrateDump(dump: Dump): Dump {\r\n  let version = dump.__meta.dbVersion;\r\n\r\n  while (version < DB_VERSION) {\r\n    const migration = upgrades[version];\r\n\r\n    if (migration?.data) {\r\n      dump = migration.data(dump); // can touch any store\r\n    } else {\r\n      dump.__meta.dbVersion = version + 1;\r\n    }\r\n\r\n    version = dump.__meta.dbVersion;\r\n  }\r\n\r\n  return dump;\r\n}\r\n\r\n\r\nexport const migration0: Migration = {\r\n    schema: (db, tx) => {\r\n        const replayStore = db.objectStoreNames.contains(STORES.replays)\r\n            ? tx.objectStore(STORES.replays)\r\n            : db.createObjectStore(STORES.replays, { keyPath: \"replayHash\" });\r\n\r\n        if (!replayStore.indexNames.contains(\"gametime\")) {\r\n            replayStore.createIndex(\"gametime\", \"gametime\", { unique: false });\r\n        }\r\n\r\n        const listsStore = db.objectStoreNames.contains(STORES.lists)\r\n            ? tx.objectStore(STORES.lists)\r\n            : db.createObjectStore(STORES.lists, { keyPath: \"replayHash\" });\r\n\r\n        if (!listsStore.indexNames.contains(\"gametime\")) {\r\n            listsStore.createIndex(\"gametime\", \"gametime\", { unique: false });\r\n        }\r\n        if (!listsStore.indexNames.contains(\"gameMode\")) {\r\n            listsStore.createIndex(\"gameMode\", \"gameMode\", { unique: false });\r\n        }\r\n        if (!listsStore.indexNames.contains(\"playerNames\")) {\r\n            listsStore.createIndex(\"playerNames\", \"playerNames\", { multiEntry: true });\r\n        }\r\n        if (!listsStore.indexNames.contains(\"commandersTeam1\")) {\r\n            listsStore.createIndex(\"commandersTeam1\", \"commandersTeam1\", { multiEntry: true });\r\n        }\r\n        if (!listsStore.indexNames.contains(\"commandersTeam2\")) {\r\n            listsStore.createIndex(\"commandersTeam2\", \"commandersTeam2\", { multiEntry: true });\r\n        }\r\n\r\n        if (!db.objectStoreNames.contains(STORES.meta)) {\r\n            const store = db.createObjectStore(STORES.meta, { keyPath: \"replayHash\" });\r\n            store.createIndex(\"uploaded\", \"uploaded\", { unique: false });\r\n            store.createIndex(\"filePath\", \"filePath\", { unique: false });\r\n            store.createIndex(\"skip\", \"skip\", { unique: false });\r\n        }\r\n\r\n        if (!db.objectStoreNames.contains(STORES.config)) {\r\n            db.createObjectStore(STORES.config);\r\n        }\r\n    },\r\n};\r\n\r\nconst migration1: Migration = {\r\n  data: (dump) => {\r\n    // Adjust ReplayMeta\r\n    const meta = dump.stores[STORES.meta] as any[] | undefined;\r\n    if (meta) {\r\n      for (const record of meta) {\r\n        if (typeof record.uploaded === \"boolean\") {\r\n          record.uploaded = record.uploaded ? 1 : 0;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Example: adjust ReplayLists\r\n    const lists = dump.stores[STORES.lists] as any[] | undefined;\r\n    if (lists) {\r\n      for (const list of lists) {\r\n        if (!list.playerNames) list.playerNames = [];\r\n      }\r\n    }\r\n\r\n    dump.__meta.dbVersion = 2;\r\n    return dump;\r\n  },\r\n};\r\n\r\nconst migration2: Migration = {\r\n  schema: (db, tx) => {\r\n    if (!db.objectStoreNames.contains(STORES.directoryHandles)) {\r\n      // no keyPath: we'll use arbitrary string keys (e.g. 'replayDir')\r\n      db.createObjectStore(STORES.directoryHandles);\r\n    }\r\n  },\r\n};\r\n\r\n\r\nconst upgrades: Record<number, Migration> = {\r\n  0: migration0, // initial schema\r\n  1: migration1, // uploaded boolean â†’ number, can modify other stores too\r\n  2: migration2, // new store for directory handles\r\n};","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","import { Dump } from \"./migration\";\r\nimport { openDB, migrateDump } from \"./db-core\";\r\n\r\nexport async function exportDb(): Promise<ArrayBuffer> {\r\n    const database = await openDB();\r\n\r\n    return new Promise((resolve, reject) => {\r\n        const tx = database.transaction(Array.from(database.objectStoreNames), \"readonly\");\r\n        const dump: Dump = { __meta: { dbVersion: database.version, date: new Date().toISOString() }, stores: {} };\r\n        let pending = database.objectStoreNames.length;\r\n\r\n        if (pending === 0) return resolve(new ArrayBuffer(0));\r\n\r\n        for (const storeName of Array.from(database.objectStoreNames)) {\r\n            const store = tx.objectStore(storeName);\r\n            const req = store.getAll();\r\n\r\n            req.onsuccess = () => {\r\n                dump.stores[storeName] = req.result;\r\n                if (--pending === 0) {\r\n                    const json = JSON.stringify(dump);\r\n                    const compressed = pako.gzip(json);\r\n                    const binary = new Uint8Array(compressed);\r\n                    resolve(binary.buffer);\r\n                }\r\n            };\r\n\r\n            req.onerror = () => reject(req.error);\r\n        }\r\n    });\r\n}\r\n\r\nexport async function importDb(json: string, replace = false): Promise<void> {\r\n    let dump: Dump = JSON.parse(json);\r\n    dump = migrateDump(dump);\r\n    const db = await openDB();\r\n\r\n    return new Promise((resolve, reject) => {\r\n        const tx = db.transaction(Array.from(db.objectStoreNames), \"readwrite\");\r\n        tx.oncomplete = () => resolve();\r\n        tx.onerror = () => reject(tx.error);\r\n\r\n        for (const [storeName, items] of Object.entries(dump.stores)) {\r\n            if (!db.objectStoreNames.contains(storeName)) continue;\r\n            const store = tx.objectStore(storeName);\r\n\r\n            if (replace) {\r\n                const clearReq = store.clear();\r\n                clearReq.onsuccess = () => {\r\n                    for (const item of items) store.put(item);\r\n                };\r\n            } else {\r\n                for (const item of items) store.put(item);\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Export DB and trigger a download as .json.gz.txt with timestamped filename\r\n */\r\nexport async function exportBackup(): Promise<void> {\r\n    const binary = await exportDb();\r\n\r\n    const blob = new Blob([binary], { type: \"application/gzip\" });\r\n\r\n    const timestamp = new Date().toISOString().replace(/[:.]/g, \"-\");\r\n    const filename = `dsstatsdb-backup-${timestamp}.idb.json.gz`;\r\n\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement(\"a\");\r\n    a.href = url;\r\n    a.download = filename;\r\n    a.click();\r\n    URL.revokeObjectURL(url);\r\n}\r\n\r\n/**\r\n * Open file picker, read backup file and import into DB\r\n */\r\nexport async function importBackup(replace: boolean = false): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n        const input = document.createElement(\"input\");\r\n        input.type = \"file\";\r\n        input.accept = \".gz,.json\";\r\n\r\n        input.onchange = async () => {\r\n            if (!input.files || input.files.length === 0) {\r\n                return reject(\"No file selected\");\r\n            }\r\n\r\n            const file = input.files[0];\r\n            const reader = new FileReader();\r\n\r\n            reader.onload = async () => {\r\n                try {\r\n                    const buffer = reader.result as ArrayBuffer;\r\n                    const binary = new Uint8Array(buffer); // for pako\r\n                    const json = pako.ungzip(binary, { to: \"string\" });\r\n                    await importDb(json, replace);\r\n                    resolve();\r\n                } catch (err) {\r\n                    reject(err);\r\n                }\r\n            };\r\n\r\n            reader.onerror = () => reject(reader.error);\r\n            reader.readAsArrayBuffer(file);\r\n        };\r\n\r\n        input.click();\r\n    });\r\n}\r\n\r\n\r\n"],"names":["STORES","db","openDB","Promise","resolve","reject","request","indexedDB","open","onupgradeneeded","event","database","target","result","tx","transaction","v","oldVersion","migration","upgrades","schema","onsuccess","onerror","error","migrateDump","dump","version","__meta","dbVersion","data","migration0","replayStore","objectStoreNames","contains","objectStore","createObjectStore","keyPath","indexNames","createIndex","unique","listsStore","multiEntry","store","migration2","meta","stores","record","uploaded","lists","list","playerNames","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","d","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","async","exportDb","Array","from","date","Date","toISOString","pending","length","ArrayBuffer","storeName","req","getAll","json","JSON","stringify","compressed","pako","gzip","binary","Uint8Array","buffer","importDb","replace","parse","oncomplete","items","entries","clear","item","put","exportBackup","blob","Blob","type","filename","url","URL","createObjectURL","a","document","createElement","href","download","click","revokeObjectURL","importBackup","input","accept","onchange","files","file","reader","FileReader","onload","ungzip","to","err","readAsArrayBuffer"],"ignoreList":[],"sourceRoot":""}