var e={61(e,t,a){a(395);new Map},82(e,t,a){a.d(t,{b:()=>s});var n=a(691),r=a(307);function o(e){return`${e.region}:${e.realm}:${e.id}`}class s{async generateStats(e){const t=new Map;let a=null;for(;;){const{replays:n,lastKey:r}=await this.getReplayChunk(a,100);if(0===n.length)break;for(const a of n){t.has(a.gameMode)||t.set(a.gameMode,{commanderStats:new Map,teammateStats:new Map,opponentStats:new Map});const n=t.get(a.gameMode);this.setStats(e,n,a)}a=r}const r=[];for(const[e,a]of t.entries())r.push({gameMode:e,commanderStats:Array.from(a.commanderStats.values()),teammateStats:Array.from(a.teammateStats.values()).filter(e=>e.count>5),opponentStats:Array.from(a.opponentStats.values()).filter(e=>e.count>5)});return{player:e,gameModeStats:r,recentReplays:await(0,n.Ci)({name:e.name,skip:0,take:10})}}setStats(e,t,a){const n=a.players.find(t=>o(t.player.toonId)===o(e.toonId));if(!n)return;const r=n.teamId,s=a.winnerTeam===r,c=n.race,i=this.isMvp(n,a.players);if(t.commanderStats.has(c)){const e=t.commanderStats.get(c);e.count+=1,s&&(e.wins+=1),i&&(e.mvp+=1)}else t.commanderStats.set(c,{commander:c,count:1,wins:s?1:0,mvp:i?1:0});for(const n of a.players){const a=o(n.player.toonId);if(a===o(e.toonId))continue;const c=n.teamId===r?t.teammateStats:t.opponentStats;if(c.has(a)){const e=c.get(a);e.count+=1,s&&(e.wins+=1)}else c.set(a,{player:n.player,count:1,wins:s?1:0})}}isMvp(e,t){let a=0;for(const t of e.spawns)if(4===t.breakpoint){a=t.killedValue;break}let n=0;for(const e of t)for(const t of e.spawns)4===t.breakpoint&&t.killedValue>n&&(n=t.killedValue);return a>0&&a===n}async findMainPlayer(){const{replays:e}=await this.getReplayChunk(null,10),t=[...e,...await this.getReplayChunkFromStart(10)],a=new Map;for(const e of t)for(const t of e.players){const e=o(t.player.toonId);a.has(e)?a.get(e).count++:a.set(e,{player:t.player,count:1})}if(0===a.size)return;let n;for(const e of a.values())(!n||e.count>n.count)&&(n=e);return n?.player}async getReplayChunkFromStart(e){const t=await(0,r.P2)();return new Promise((a,n)=>{const o=t.transaction(r.ZZ.replays,"readonly").objectStore(r.ZZ.replays).index("gametime"),s=[],c=o.openCursor(null,"next");c.onsuccess=t=>{const n=t.target.result;n&&s.length<e?(s.push(n.value),n.continue()):a(s)},c.onerror=()=>n(c.error)})}async getReplayChunk(e,t){const a=await(0,r.P2)();return new Promise((n,o)=>{const s=a.transaction(r.ZZ.replays,"readonly").objectStore(r.ZZ.replays).index("gametime"),c=[];let i=null;const l=e?IDBKeyRange.upperBound(e,!0):null,m=s.openCursor(l,"prev");m.onsuccess=e=>{const a=e.target.result;a&&c.length<t?(c.push(a.value),i=a.key,a.continue()):n({replays:c,lastKey:i})},m.onerror=()=>o(m.error)})}}},283(e,t,a){a(307)},307(e,t,a){a.d(t,{P2:()=>o,ZZ:()=>n});const n={replays:"Replays",lists:"ReplayLists",meta:"ReplayMeta",config:"Config",directoryHandles:"DirectoryHandles"};let r=null;function o(){return new Promise((e,t)=>{if(r)return void e(r);const a=indexedDB.open("ReplayDB",3);a.onupgradeneeded=e=>{const t=e.target.result,a=e.target.transaction;for(let n=e.oldVersion;n<3;n++){const e=i[n];e?.schema&&e.schema(t,a)}},a.onsuccess=()=>{r=a.result,e(r)},a.onerror=()=>t(a.error)})}const s={schema:(e,t)=>{const a=e.objectStoreNames.contains(n.replays)?t.objectStore(n.replays):e.createObjectStore(n.replays,{keyPath:"replayHash"});a.indexNames.contains("gametime")||a.createIndex("gametime","gametime",{unique:!1});const r=e.objectStoreNames.contains(n.lists)?t.objectStore(n.lists):e.createObjectStore(n.lists,{keyPath:"replayHash"});if(r.indexNames.contains("gametime")||r.createIndex("gametime","gametime",{unique:!1}),r.indexNames.contains("gameMode")||r.createIndex("gameMode","gameMode",{unique:!1}),r.indexNames.contains("playerNames")||r.createIndex("playerNames","playerNames",{multiEntry:!0}),r.indexNames.contains("commandersTeam1")||r.createIndex("commandersTeam1","commandersTeam1",{multiEntry:!0}),r.indexNames.contains("commandersTeam2")||r.createIndex("commandersTeam2","commandersTeam2",{multiEntry:!0}),!e.objectStoreNames.contains(n.meta)){const t=e.createObjectStore(n.meta,{keyPath:"replayHash"});t.createIndex("uploaded","uploaded",{unique:!1}),t.createIndex("filePath","filePath",{unique:!1}),t.createIndex("skip","skip",{unique:!1})}e.objectStoreNames.contains(n.config)||e.createObjectStore(n.config)}},c={schema:(e,t)=>{e.objectStoreNames.contains(n.directoryHandles)||e.createObjectStore(n.directoryHandles)}},i={0:s,1:{data:e=>{const t=e.stores[n.meta];if(t)for(const e of t)"boolean"==typeof e.uploaded&&(e.uploaded=e.uploaded?1:0);const a=e.stores[n.lists];if(a)for(const e of a)e.playerNames||(e.playerNames=[]);return e.__meta.dbVersion=2,e}},2:c}},395(e,t,a){a(307)},691(e,t,a){a.d(t,{Ci:()=>o});var n=a(307);a(61),a(283),a(82),a(395);async function r(e){const t=await(0,n.P2)(),a=e.name&&e.name.length>0,r=e.commanders&&e.commanders.length>0,o=t.transaction(n.ZZ.lists,"readonly").objectStore(n.ZZ.lists);let s=[];if(r){const t=o.index("commandersTeam1"),a=o.index("commandersTeam2"),n=new Set,r=e.commanders.map(e=>[new Promise((a,n)=>{const r=t.getAll(IDBKeyRange.only(e));r.onsuccess=()=>a(r.result),r.onerror=()=>n(r.error)}),new Promise((t,n)=>{const r=a.getAll(IDBKeyRange.only(e));r.onsuccess=()=>t(r.result),r.onerror=()=>n(r.error)})]).flat();(await Promise.all(r)).flat().forEach(e=>{n.has(e.replayHash)||(s.push(e),n.add(e.replayHash))})}else s=await new Promise((e,t)=>{const a=o.getAll();a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error)});if(!a)return s;const c=a?e.name.toLowerCase().split(" ").filter(e=>e):[];return s.filter(t=>{if(e.linkCommanders&&a&&r){const a=t.playerNames.map(e=>e.toLowerCase()),n=[...t.commandersTeam1,...t.commandersTeam2];return a.some((t,a)=>{if(c.every(e=>t.includes(e))){const t=n[a];return e.commanders.includes(t)}return!1})}if(a){const e=t.playerNames.map(e=>e.toLowerCase());return c.every(t=>e.some(e=>e.includes(t)))}return!0})}async function o(e){const t=await r(e),a=e.tableOrders&&e.tableOrders.length>0?e.tableOrders:[{name:"gametime",ascending:!1}];return t.sort((e,t)=>{for(const n of a){const a=e[n.name],r=t[n.name];if(Array.isArray(a)||Array.isArray(r))continue;const o=void 0===a?0:a,s=void 0===r?0:r;if(o<s)return n.ascending?-1:1;if(o>s)return n.ascending?1:-1}return 0}),void 0!==e.skip&&void 0!==e.take?t.slice(e.skip,e.skip+e.take):t}}},t={};function a(n){var r=t[n];if(void 0!==r)return r.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,a),o.exports}a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const n=a(82).b;export{n as StatsService};
//# sourceMappingURL=stats.js.map