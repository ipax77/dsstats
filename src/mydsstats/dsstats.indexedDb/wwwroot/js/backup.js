var e={307(e,t,o){o.d(t,{OA:()=>d,P2:()=>m});const r="Replays",n="ReplayLists",a="ReplayMeta",s="Config",c="DirectoryHandles";let i=null;function m(){return new Promise((e,t)=>{if(i)return void e(i);const o=indexedDB.open("ReplayDB",3);o.onupgradeneeded=e=>{const t=e.target.result,o=e.target.transaction;for(let r=e.oldVersion;r<3;r++){const e=p[r];e?.schema&&e.schema(t,o)}},o.onsuccess=()=>{i=o.result,e(i)},o.onerror=()=>t(o.error)})}function d(e){let t=e.__meta.dbVersion;for(;t<3;){const o=p[t];o?.data?e=o.data(e):e.__meta.dbVersion=t+1,t=e.__meta.dbVersion}return e}const l={schema:(e,t)=>{const o=e.objectStoreNames.contains(r)?t.objectStore(r):e.createObjectStore(r,{keyPath:"replayHash"});o.indexNames.contains("gametime")||o.createIndex("gametime","gametime",{unique:!1});const c=e.objectStoreNames.contains(n)?t.objectStore(n):e.createObjectStore(n,{keyPath:"replayHash"});if(c.indexNames.contains("gametime")||c.createIndex("gametime","gametime",{unique:!1}),c.indexNames.contains("gameMode")||c.createIndex("gameMode","gameMode",{unique:!1}),c.indexNames.contains("playerNames")||c.createIndex("playerNames","playerNames",{multiEntry:!0}),c.indexNames.contains("commandersTeam1")||c.createIndex("commandersTeam1","commandersTeam1",{multiEntry:!0}),c.indexNames.contains("commandersTeam2")||c.createIndex("commandersTeam2","commandersTeam2",{multiEntry:!0}),!e.objectStoreNames.contains(a)){const t=e.createObjectStore(a,{keyPath:"replayHash"});t.createIndex("uploaded","uploaded",{unique:!1}),t.createIndex("filePath","filePath",{unique:!1}),t.createIndex("skip","skip",{unique:!1})}e.objectStoreNames.contains(s)||e.createObjectStore(s)}},u={schema:(e,t)=>{e.objectStoreNames.contains(c)||e.createObjectStore(c)}},p={0:l,1:{data:e=>{const t=e.stores[a];if(t)for(const e of t)"boolean"==typeof e.uploaded&&(e.uploaded=e.uploaded?1:0);const o=e.stores[n];if(o)for(const e of o)e.playerNames||(e.playerNames=[]);return e.__meta.dbVersion=2,e}},2:u}}},t={};function o(r){var n=t[r];if(void 0!==n)return n.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,o),a.exports}o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var r={};o.d(r,{Is:()=>i,K1:()=>s,Xl:()=>c,zP:()=>a});var n=o(307);async function a(){const e=await(0,n.P2)();return new Promise((t,o)=>{const r=e.transaction(Array.from(e.objectStoreNames),"readonly"),n={__meta:{dbVersion:e.version,date:(new Date).toISOString()},stores:{}};let a=e.objectStoreNames.length;if(0===a)return t(new ArrayBuffer(0));for(const s of Array.from(e.objectStoreNames)){const e=r.objectStore(s).getAll();e.onsuccess=()=>{if(n.stores[s]=e.result,0===--a){const e=JSON.stringify(n),o=pako.gzip(e),r=new Uint8Array(o);t(r.buffer)}},e.onerror=()=>o(e.error)}})}async function s(e,t=!1){let o=JSON.parse(e);o=(0,n.OA)(o);const r=await(0,n.P2)();return new Promise((e,n)=>{const a=r.transaction(Array.from(r.objectStoreNames),"readwrite");a.oncomplete=()=>e(),a.onerror=()=>n(a.error);for(const[e,n]of Object.entries(o.stores)){if(!r.objectStoreNames.contains(e))continue;const o=a.objectStore(e);if(t){o.clear().onsuccess=()=>{for(const e of n)o.put(e)}}else for(const e of n)o.put(e)}})}async function c(){const e=await a(),t=new Blob([e],{type:"application/gzip"}),o=`dsstatsdb-backup-${(new Date).toISOString().replace(/[:.]/g,"-")}.idb.json.gz`,r=URL.createObjectURL(t),n=document.createElement("a");n.href=r,n.download=o,n.click(),URL.revokeObjectURL(r)}async function i(e=!1){return new Promise((t,o)=>{const r=document.createElement("input");r.type="file",r.accept=".gz,.json",r.onchange=async()=>{if(!r.files||0===r.files.length)return o("No file selected");const n=r.files[0],a=new FileReader;a.onload=async()=>{try{const o=a.result,r=new Uint8Array(o),n=pako.ungzip(r,{to:"string"});await s(n,e),t()}catch(e){o(e)}},a.onerror=()=>o(a.error),a.readAsArrayBuffer(n)},r.click()})}const m=r.Xl,d=r.zP,l=r.Is,u=r.K1;export{m as exportBackup,d as exportDb,l as importBackup,u as importDb};
//# sourceMappingURL=backup.js.map