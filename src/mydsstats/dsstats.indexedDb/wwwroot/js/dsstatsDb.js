var e={61(e,t,r){r.d(t,{A:()=>c,p:()=>o});var n=r(395);const a=new Map;async function o(e,t,r,o,c){a.clear();const i=new Set(r);try{if(null==c){if(null==(c=await(0,n.xV)()))return[];await(0,n.LB)(`${c.name}_${e}`,c)}else await(0,n.sf)(c);const r=await s(c,i,t,!0,c.name),l=r.sort((e,t)=>t.record.lastModified-e.record.lastModified).slice(0,o);for(const{record:e,file:t}of l)a.set(e.path,t);return l.map(({record:e})=>e)}catch(e){return console.log("Failed getting file infos: "+e.message),[]}}async function s(e,t,r,n,a){const o=[];for await(const[c,i]of e.entries()){const e=a?`${a}/${c}`:c;if("directory"!==i.kind){if("file"===i.kind){if(!c.startsWith(r))continue;if(t.has(e))continue;const n=await i.getFile();o.push({record:{path:e,name:n.name,size:n.size,lastModified:n.lastModified},file:n})}}else if(n){const a=await s(i,t,r,n,e);o.push(...a)}}return o}async function c(e){const t=a.get(e);if(!t)throw new Error(`File not found: ${e}`);return t.stream()}},82(e,t,r){r.d(t,{b:()=>s});var n=r(691),a=r(307);function o(e){return`${e.region}:${e.realm}:${e.id}`}class s{async generateStats(e){const t=new Map;let r=null;for(;;){const{replays:n,lastKey:a}=await this.getReplayChunk(r,100);if(0===n.length)break;for(const r of n){t.has(r.gameMode)||t.set(r.gameMode,{commanderStats:new Map,teammateStats:new Map,opponentStats:new Map});const n=t.get(r.gameMode);this.setStats(e,n,r)}r=a}const a=[];for(const[e,r]of t.entries())a.push({gameMode:e,commanderStats:Array.from(r.commanderStats.values()),teammateStats:Array.from(r.teammateStats.values()).filter(e=>e.count>5),opponentStats:Array.from(r.opponentStats.values()).filter(e=>e.count>5)});return{player:e,gameModeStats:a,recentReplays:await(0,n.Ci)({name:e.name,skip:0,take:10})}}setStats(e,t,r){const n=r.players.find(t=>o(t.player.toonId)===o(e.toonId));if(!n)return;const a=n.teamId,s=r.winnerTeam===a,c=n.race,i=this.isMvp(n,r.players);if(t.commanderStats.has(c)){const e=t.commanderStats.get(c);e.count+=1,s&&(e.wins+=1),i&&(e.mvp+=1)}else t.commanderStats.set(c,{commander:c,count:1,wins:s?1:0,mvp:i?1:0});for(const n of r.players){const r=o(n.player.toonId);if(r===o(e.toonId))continue;const c=n.teamId===a?t.teammateStats:t.opponentStats;if(c.has(r)){const e=c.get(r);e.count+=1,s&&(e.wins+=1)}else c.set(r,{player:n.player,count:1,wins:s?1:0})}}isMvp(e,t){let r=0;for(const t of e.spawns)if(4===t.breakpoint){r=t.killedValue;break}let n=0;for(const e of t)for(const t of e.spawns)4===t.breakpoint&&t.killedValue>n&&(n=t.killedValue);return r>0&&r===n}async findMainPlayer(){const{replays:e}=await this.getReplayChunk(null,10),t=[...e,...await this.getReplayChunkFromStart(10)],r=new Map;for(const e of t)for(const t of e.players){const e=o(t.player.toonId);r.has(e)?r.get(e).count++:r.set(e,{player:t.player,count:1})}if(0===r.size)return;let n;for(const e of r.values())(!n||e.count>n.count)&&(n=e);return n?.player}async getReplayChunkFromStart(e){const t=await(0,a.P2)();return new Promise((r,n)=>{const o=t.transaction(a.ZZ.replays,"readonly").objectStore(a.ZZ.replays).index("gametime"),s=[],c=o.openCursor(null,"next");c.onsuccess=t=>{const n=t.target.result;n&&s.length<e?(s.push(n.value),n.continue()):r(s)},c.onerror=()=>n(c.error)})}async getReplayChunk(e,t){const r=await(0,a.P2)();return new Promise((n,o)=>{const s=r.transaction(a.ZZ.replays,"readonly").objectStore(a.ZZ.replays).index("gametime"),c=[];let i=null;const l=e?IDBKeyRange.upperBound(e,!0):null,m=s.openCursor(l,"prev");m.onsuccess=e=>{const r=e.target.result;r&&c.length<t?(c.push(r.value),i=r.key,r.continue()):n({replays:c,lastKey:i})},m.onerror=()=>o(m.error)})}}},283(e,t,r){r.d(t,{Is:()=>o,Xl:()=>a});var n=r(307);async function a(){const e=await async function(){const e=await(0,n.P2)();return new Promise((t,r)=>{const n=e.transaction(Array.from(e.objectStoreNames),"readonly"),a={__meta:{dbVersion:e.version,date:(new Date).toISOString()},stores:{}};let o=e.objectStoreNames.length;if(0===o)return t(new ArrayBuffer(0));for(const s of Array.from(e.objectStoreNames)){const e=n.objectStore(s).getAll();e.onsuccess=()=>{if(a.stores[s]=e.result,0===--o){const e=JSON.stringify(a),r=pako.gzip(e),n=new Uint8Array(r);t(n.buffer)}},e.onerror=()=>r(e.error)}})}(),t=new Blob([e],{type:"application/gzip"}),r=`dsstatsdb-backup-${(new Date).toISOString().replace(/[:.]/g,"-")}.idb.json.gz`,a=URL.createObjectURL(t),o=document.createElement("a");o.href=a,o.download=r,o.click(),URL.revokeObjectURL(a)}async function o(e=!1){return new Promise((t,r)=>{const a=document.createElement("input");a.type="file",a.accept=".gz,.json",a.onchange=async()=>{if(!a.files||0===a.files.length)return r("No file selected");const o=a.files[0],s=new FileReader;s.onload=async()=>{try{const r=s.result,a=new Uint8Array(r),o=pako.ungzip(a,{to:"string"});await async function(e,t=!1){let r=JSON.parse(e);r=(0,n.OA)(r);const a=await(0,n.P2)();return new Promise((e,n)=>{const o=a.transaction(Array.from(a.objectStoreNames),"readwrite");o.oncomplete=()=>e(),o.onerror=()=>n(o.error);for(const[e,n]of Object.entries(r.stores)){if(!a.objectStoreNames.contains(e))continue;const r=o.objectStore(e);if(t)r.clear().onsuccess=()=>{for(const e of n)r.put(e)};else for(const e of n)r.put(e)}})}(o,e),t()}catch(e){r(e)}},s.onerror=()=>r(s.error),s.readAsArrayBuffer(o)},a.click()})}},307(e,t,r){r.d(t,{OA:()=>s,P2:()=>o,ZZ:()=>n});const n={replays:"Replays",lists:"ReplayLists",meta:"ReplayMeta",config:"Config",directoryHandles:"DirectoryHandles"};let a=null;function o(){return new Promise((e,t)=>{if(a)return void e(a);const r=indexedDB.open("ReplayDB",3);r.onupgradeneeded=e=>{const t=e.target.result,r=e.target.transaction;for(let n=e.oldVersion;n<3;n++){const e=l[n];e?.schema&&e.schema(t,r)}},r.onsuccess=()=>{a=r.result,e(a)},r.onerror=()=>t(r.error)})}function s(e){let t=e.__meta.dbVersion;for(;t<3;){const r=l[t];r?.data?e=r.data(e):e.__meta.dbVersion=t+1,t=e.__meta.dbVersion}return e}const c={schema:(e,t)=>{const r=e.objectStoreNames.contains(n.replays)?t.objectStore(n.replays):e.createObjectStore(n.replays,{keyPath:"replayHash"});r.indexNames.contains("gametime")||r.createIndex("gametime","gametime",{unique:!1});const a=e.objectStoreNames.contains(n.lists)?t.objectStore(n.lists):e.createObjectStore(n.lists,{keyPath:"replayHash"});if(a.indexNames.contains("gametime")||a.createIndex("gametime","gametime",{unique:!1}),a.indexNames.contains("gameMode")||a.createIndex("gameMode","gameMode",{unique:!1}),a.indexNames.contains("playerNames")||a.createIndex("playerNames","playerNames",{multiEntry:!0}),a.indexNames.contains("commandersTeam1")||a.createIndex("commandersTeam1","commandersTeam1",{multiEntry:!0}),a.indexNames.contains("commandersTeam2")||a.createIndex("commandersTeam2","commandersTeam2",{multiEntry:!0}),!e.objectStoreNames.contains(n.meta)){const t=e.createObjectStore(n.meta,{keyPath:"replayHash"});t.createIndex("uploaded","uploaded",{unique:!1}),t.createIndex("filePath","filePath",{unique:!1}),t.createIndex("skip","skip",{unique:!1})}e.objectStoreNames.contains(n.config)||e.createObjectStore(n.config)}},i={schema:(e,t)=>{e.objectStoreNames.contains(n.directoryHandles)||e.createObjectStore(n.directoryHandles)}},l={0:c,1:{data:e=>{const t=e.stores[n.meta];if(t)for(const e of t)"boolean"==typeof e.uploaded&&(e.uploaded=e.uploaded?1:0);const r=e.stores[n.lists];if(r)for(const e of r)e.playerNames||(e.playerNames=[]);return e.__meta.dbVersion=2,e}},2:i}},395(e,t,r){r.d(t,{LB:()=>a,SO:()=>s,Wm:()=>o,Xg:()=>c,sf:()=>i,xV:()=>l});var n=r(307);async function a(e,t){const r=await(0,n.P2)();return new Promise((a,o)=>{const s=r.transaction(n.ZZ.directoryHandles,"readwrite").objectStore(n.ZZ.directoryHandles).put(t,e);s.onsuccess=()=>a(),s.onerror=()=>o(s.error)})}async function o(e){const t=await(0,n.P2)();return new Promise(r=>{const a=t.transaction(n.ZZ.directoryHandles,"readonly").objectStore(n.ZZ.directoryHandles).get(e);a.onsuccess=()=>r(a.result??null),a.onerror=()=>r(null)})}async function s(){const e=await(0,n.P2)();return new Promise(t=>{const r=e.transaction(n.ZZ.directoryHandles,"readonly").objectStore(n.ZZ.directoryHandles).getAllKeys();r.onsuccess=()=>t(r.result),r.onerror=()=>t([])})}async function c(e){const t=await(0,n.P2)();return new Promise((r,a)=>{const o=t.transaction(n.ZZ.directoryHandles,"readwrite");o.objectStore(n.ZZ.directoryHandles).delete(e),o.oncomplete=()=>r(!0),o.onerror=()=>a(o.error)})}async function i(e,t="read"){if(!e)return!1;const r={mode:t};if("granted"===await(e.queryPermission?.(r)))return!0;return"granted"===await(e.requestPermission?.(r))}async function l(){if(!("showDirectoryPicker"in window))throw new Error("showDirectoryPicker is not supported in this browser. File selection requires a Chromium-based browser.");try{return await window.showDirectoryPicker()}catch(e){if("AbortError"===e?.name)return null;throw new Error(`Failed to pick directory: ${e?.message??e}`)}}},691(e,t,r){r.d(t,{$s:()=>P,Ci:()=>Z,Jm:()=>u,KH:()=>l,Kw:()=>k,LA:()=>b,PD:()=>m,PP:()=>f,Wz:()=>i,bz:()=>x,eO:()=>y,eU:()=>d,gg:()=>A,iG:()=>N,jN:()=>p,kI:()=>j,lV:()=>R,pL:()=>v,ql:()=>h,uP:()=>g,zj:()=>w});var n=r(307),a=r(61),o=r(283),s=r(82),c=r(395);async function i(e,t,r,a){const o=await(0,n.P2)();return new Promise((s,c)=>{const i=o.transaction([n.ZZ.replays,n.ZZ.lists,n.ZZ.meta],"readwrite"),l=i.objectStore(n.ZZ.replays),m=i.objectStore(n.ZZ.lists),u=i.objectStore(n.ZZ.meta);l.put({...t,replayHash:e,gametime:t.gametime}),m.put({...r,gametime:r.gametime}),u.put(a),i.oncomplete=()=>s(),i.onerror=()=>c(i.error)})}async function l(){const e=await(0,n.P2)();return new Promise((t,r)=>{const a=e.transaction(n.ZZ.lists,"readonly").objectStore(n.ZZ.lists).getAll();a.onsuccess=()=>{const e=a.result.map(e=>({...e,gameTime:e.gametime}));t(e)},a.onerror=()=>r(a.error)})}async function m(){const e=await(0,n.P2)();return new Promise((t,r)=>{const a=e.transaction(n.ZZ.meta,"readonly").objectStore(n.ZZ.meta).getAll();a.onsuccess=()=>{t(a.result)},a.onerror=()=>r(a.error)})}async function u(e){const t=await(0,n.P2)();return new Promise((r,a)=>{const o=t.transaction(n.ZZ.replays,"readonly").objectStore(n.ZZ.replays).get(e);o.onsuccess=()=>{const e=o.result;e&&(e.gametime=new Date(e.gametime).toISOString()),r(e)},o.onerror=()=>a(o.error)})}async function d(e=1e3){const t=await(0,n.P2)();return new Promise((r,a)=>{const o=t.transaction(n.ZZ.meta,"readonly").objectStore(n.ZZ.meta).index("uploaded").getAll(IDBKeyRange.only(0));o.onsuccess=async()=>{const s=o.result;if(0===s.length)return void r({hashes:[],payload:k("[]")});const c=t.transaction(n.ZZ.replays,"readonly").objectStore(n.ZZ.replays),i=s.map(e=>new Promise((t,r)=>{const n=c.get(e.replayHash);n.onsuccess=()=>t({hash:e.replayHash,replay:n.result}),n.onerror=()=>r(n.error)}));try{const t=(await Promise.all(i)).filter(e=>!!e.replay);t.sort((e,t)=>new Date(t.replay.gametime).getTime()-new Date(e.replay.gametime).getTime());const n=t.slice(0,e),a=n.map(e=>e.hash),o=n.map(e=>e.replay),s=k(JSON.stringify(o));r({hashes:a,payload:s})}catch(e){a(e)}},o.onerror=()=>a(o.error)})}async function p(e,t=250){const r=await(0,n.P2)();return new Promise((a,o)=>{const s=r.transaction(n.ZZ.meta,"readonly").objectStore(n.ZZ.meta).index("uploaded").getAll(IDBKeyRange.only(0));s.onsuccess=async()=>{const c=s.result;if(0===c.length)return void a({hashes:[],payload:new Uint8Array});const i=r.transaction(n.ZZ.replays,"readonly").objectStore(n.ZZ.replays),l=c.map(e=>new Promise((t,r)=>{const n=i.get(e.replayHash);n.onsuccess=()=>t({hash:e.replayHash,replay:n.result}),n.onerror=()=>r(n.error)}));try{const r=(await Promise.all(l)).filter(e=>!!e.replay);r.sort((e,t)=>new Date(t.replay.gametime).getTime()-new Date(e.replay.gametime).getTime());const n=r.slice(0,t),o=n.map(e=>e.hash),s=n.map(e=>e.replay),c={...JSON.parse(JSON.stringify(e)),replays:s},i=A(JSON.stringify(c));a({hashes:o,payload:i})}catch(e){console.error("exportUnuploadedReplays10 failed:",e),o(e)}},s.onerror=()=>o(s.error)})}async function y(e){const t=(await(0,n.P2)()).transaction(n.ZZ.meta,"readwrite").objectStore(n.ZZ.meta);await Promise.all(e.map(e=>new Promise((r,n)=>{const a=t.get(e);a.onsuccess=()=>{const e=a.result;if(e){e.uploaded=1;const a=t.put(e);a.onsuccess=()=>r(),a.onerror=()=>n(a.error)}else r()},a.onerror=()=>n(a.error)})))}async function f(e,t,r,n=100){const o=(await m()).filter(t=>t.regionId===e).map(e=>e.filePath),s=r?await(0,c.Wm)(r):null;return await(0,a.p)(e,t,o,n,s??void 0)}async function g(e){return await(0,a.A)(e)}async function w(){const e=await(0,n.P2)();return new Promise((t,r)=>{const a=e.transaction(n.ZZ.config,"readonly").objectStore(n.ZZ.config).get("app");a.onsuccess=()=>{t(a.result)},a.onerror=()=>r(a.error)})}async function h(e){const t=await(0,n.P2)();return new Promise((r,a)=>{const o=t.transaction(n.ZZ.config,"readwrite");o.objectStore(n.ZZ.config).put(e,"app"),o.oncomplete=()=>r(),o.onerror=()=>a(o.error)})}async function S(e){const t=await(0,n.P2)(),r=e.name&&e.name.length>0,a=e.commanders&&e.commanders.length>0,o=t.transaction(n.ZZ.lists,"readonly").objectStore(n.ZZ.lists);let s=[];if(a){const t=o.index("commandersTeam1"),r=o.index("commandersTeam2"),n=new Set,a=e.commanders.map(e=>[new Promise((r,n)=>{const a=t.getAll(IDBKeyRange.only(e));a.onsuccess=()=>r(a.result),a.onerror=()=>n(a.error)}),new Promise((t,n)=>{const a=r.getAll(IDBKeyRange.only(e));a.onsuccess=()=>t(a.result),a.onerror=()=>n(a.error)})]).flat();(await Promise.all(a)).flat().forEach(e=>{n.has(e.replayHash)||(s.push(e),n.add(e.replayHash))})}else s=await new Promise((e,t)=>{const r=o.getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)});if(!r)return s;const c=r?e.name.toLowerCase().split(" ").filter(e=>e):[];return s.filter(t=>{if(e.linkCommanders&&r&&a){const r=t.playerNames.map(e=>e.toLowerCase()),n=[...t.commandersTeam1,...t.commandersTeam2];return r.some((t,r)=>{if(c.every(e=>t.includes(e))){const t=n[r];return e.commanders.includes(t)}return!1})}if(r){const e=t.playerNames.map(e=>e.toLowerCase());return c.every(t=>e.some(e=>e.includes(t)))}return!0})}async function Z(e){const t=await S(e),r=e.tableOrders&&e.tableOrders.length>0?e.tableOrders:[{name:"gametime",ascending:!1}];return t.sort((e,t)=>{for(const n of r){const r=e[n.name],a=t[n.name];if(Array.isArray(r)||Array.isArray(a))continue;const o=void 0===r?0:r,s=void 0===a?0:a;if(o<s)return n.ascending?-1:1;if(o>s)return n.ascending?1:-1}return 0}),void 0!==e.skip&&void 0!==e.take?t.slice(e.skip,e.skip+e.take):t}async function b(e){return(await S(e)).length}async function P(){await(0,o.Xl)()}async function j(){await(0,o.Is)()}function k(e){const t=pako.gzip(e);return btoa(String.fromCharCode(...t))}function A(e){return pako.gzip(e)}function v(e){const t=Uint8Array.from(atob(e),e=>e.charCodeAt(0));return pako.ungzip(t,{to:"string"})}async function x(e){const t=new s.b;return await t.generateStats(e)}async function N(){return await(0,c.SO)()}async function R(e){await(0,c.Xg)(e)}}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var n=r(691);const a=n.lV,o=n.$s,s=n.iG,c=n.eU,i=n.jN,l=n.KH,m=n.PD,u=n.zj,d=n.uP,p=n.Ci,y=n.LA,f=n.bz,g=n.Jm,w=n.Kw,h=n.gg,S=n.eO,Z=n.PP,b=n.ql,P=n.Wz,j=n.pL,k=n.kI;export{a as delDirectoryHandle,o as downloadBackup,s as exportAllDirectoryHandles,c as exportUnuploadedReplays,i as exportUnuploadedReplays10,l as getAllReplayLists,m as getAllReplayMatas,u as getConfig,d as getFileContentStream,p as getFilteredReplayLists,y as getFilteredReplayListsCount,f as getPlayerStats,g as getReplayByHash,w as gzipString,h as gzipStringRaw,S as markReplaysAsUploaded,Z as pickDirectoryInit,b as saveConfig,P as saveReplayFull,j as ungzipString,k as uploadBackup};
//# sourceMappingURL=dsstatsDb.js.map