@page "/tourneys/upload"
@using dsstats.razorlib.Tourneys
@using dsstats.web.Client.Services
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<UploadPage> logger
@layout TourneysLayout
@implements IDisposable

<PageTitle>dsstats - tourneys upload</PageTitle>

<dsstats.web.Client.Pages.Auth.AuthStatusComponent RedirectUrl="/tourneys/upload" />

<AuthorizeView>
    <Authorized>
        <p>under construction</p>
        <p>@data</p>
    </Authorized>
    <NotAuthorized>
        <p>NotAuthorized</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    string data = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        AuthenticationStateProvider.AuthenticationStateChanged += AuthStateChanged;
        await base.OnInitializedAsync();
    }

    private void AuthStateChanged(Task<AuthenticationState> task)
    {
        _ = LoadData();
    }

    private async Task LoadData()
    {
        if (AuthenticationStateProvider is ExternalAuthStateProvider externalAuthStateProvider)
        {
            try
            {
                if (externalAuthStateProvider.TryGetApiHttpClient(out var httpClient)
                    && httpClient is not null)
                {
                    var controller = "api8/v1/ManageTourney";

                    var response = await httpClient.GetAsync($"{controller}/test1");
                    response.EnsureSuccessStatusCode();
                    data = await response.Content.ReadAsStringAsync();
                }
            }
            catch (Exception ex)
            {
                logger.LogError("failed getting data: {error}", ex.Message);
                data = ex.Message;
            }
        }
        await InvokeAsync(() => StateHasChanged());
    }

    public void Dispose()
    {
        AuthenticationStateProvider.AuthenticationStateChanged -= AuthStateChanged;
    }
}
