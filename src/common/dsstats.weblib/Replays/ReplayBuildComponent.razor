@using Microsoft.JSInterop
@using dsstats.shared
@using dsstats.shared.Units

<div class="card bgchart w-auto">
    <div class="card-header bgchart2 rounded">
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="preload-@(Player.Race.ToString().ToLower())" alt="@Player.Race" style="width: 25px; height: 25px;"></div>
            <span class="badge @badgeClass" style="font-size: 1.1rem;">
                #@Player.GamePos @Player.Name
            </span>
            <div>
                <button class="btn btn-sm btn-outline-light bgchart" type="button" data-bs-toggle="collapse"
                        data-bs-target="@($"#Player{Player.GamePos}Map")" aria-expanded="false"
                        aria-controls="@($"Player{Player.GamePos}Map")" @onclick="e => showMap = !showMap">
                    <span class="oi @(showMap ? "bi-chevron-down" : "bi-chevron-up")"></span>
                    Map
                </button>
            </div>
        </div>
        <div class="d-flex align-items-center justify-content-between">
            <div class="ms-1 me-1">
                <button class="btn btn-sm btn-outline-warning bgchart" type="button" data-bs-toggle="collapse"
                        data-bs-target="@($"#Player{Player.GamePos}Gas")" aria-expanded="false"
                        aria-controls="@($"Player{Player.GamePos}Gas")" @onclick="e => showGas = !showGas">
                    <span class="bi @(showGas ? "bi-chevron-down" : "bi-chevron-up")"></span>
                    Gas @spawn?.GasCount
                </button>
            </div>
            <div class="">
                <button class="btn btn-sm btn-outline-light bgchart" type="button" data-bs-toggle="collapse"
                        data-bs-target="@($"#Player{Player.GamePos}Upgrades")" aria-expanded="false"
                        aria-controls="@($"Player{Player.GamePos}Upgrades")" @onclick="e => showUpgrades = !showUpgrades">
                    <span class="bi @(showUpgrades ? "bi-chevron-down" : "bi-chevron-up")"></span>
                    Upgrades @ReplayHelper.GetNumberString(spawn?.UpgradeSpent)
                </button>
            </div>
        </div>
    </div>
    <div class="card-body bgchart">
        <div class="collapse" id="@($"Player{Player.GamePos}Map")">
            <div class="bgchart" style="height: 600px; width: 500px;">
                @if (showMap)
                {
                    <BuildChart @ref="buildChart" Spawn="spawn" Team="Player.TeamId" Cmdr="Player.Race" moduleTask="moduleTask" />
                }
            </div>
        </div>
        <div class="collapse" id="@($"Player{Player.GamePos}Gas")">
            <RefineryInfoComponent Player="Player" />
        </div>
        <div class="collapse" id="@($"Player{Player.GamePos}Upgrades")">
            <UpgradesComponent Player="Player" />
        </div>
        <div class="d-flex justify-content-center">
            <table class="tptable border rounded p-2 w-auto">
                <thead>
                    <tr>
                        <td></td>
                        <td>Unit</td>
                        <td>Count</td>
                    </tr>
                </thead>
                <tbody>
                    @if (spawn != null)
                    {
                        @foreach (var unit in spawn.Units.OrderByDescending(o => o.Count))
                        {
                            var unitInfo = UnitMap.GetUnitInfo(unit.Name, Player.Race);
                            <tr @onmouseover="e => HighlightUnits(unitInfo.Name)">
                                <td>
                                    <span class="unit-color-indicator" style="background-color: @($"{UnitMap.GetColor(unitInfo.Name)}CC")"></span>
                                </td>
                                <td>@unitInfo.Name</td>
                                <td class="text-start">@unit.Count</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public ReplayPlayerDto Player { get; set; } = default!;

    [Parameter, EditorRequired]
    public ReplayHelper ReplayHelper { get; set; } = default!;

    [Parameter, EditorRequired]
    public Lazy<Task<IJSObjectReference>> moduleTask { get; set; } = default!;

    BuildChart? buildChart;
    private bool showMap = false;
    private bool showGas = false;
    private bool showUpgrades = false;

    private SpawnDto? spawn => ReplayHelper.GetSpawn(Player);
    private string badgeClass => ReplayHelper.IsWinner(Player) ? "text-bg-success" : "text-bg-danger";

    private async Task HighlightUnits(string name)
    {
        if (buildChart is null)
        {
            return;
        }
        await buildChart.HighlightUnits(name);
    }
}
