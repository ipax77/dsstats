@using Microsoft.JSInterop
@using dsstats.shared
@using pax.BlazorChartJs
@inject IJSRuntime JSRuntime
@implements IDisposable

<ChartComponent @ref="chartComponent" ChartJsConfig="chartConfig" OnEventTriggered="EventTriggered" />

@code {
    [Parameter, EditorRequired]
    public RatingDetails RatingDetails { get; set; } = new();

    bool chartReady;
    bool isRegistered;

    ChartJsConfig chartConfig = null!;
    ChartComponent? chartComponent;

    private Lazy<Task<IJSObjectReference>> moduleTask = null!;

    protected override void OnInitialized()
    {
        chartConfig = GetLineChartConfig();
        moduleTask = new(() => JSRuntime.InvokeAsync<IJSObjectReference>(
                        "import", "./_content/dsstats.weblib/js/timeChart.js").AsTask());
        base.OnInitialized();
    }

    private async void EventTriggered(ChartJsEvent chartEvent)
    {
        if (chartEvent is ChartJsInitEvent initEvent)
        {
            var success = await RegisterPlugin();
            chartReady = !success;
            SetupChart();
        }
    }

    public void Update(RatingDetails ratingDetails)
    {
        RatingDetails = ratingDetails;
        SetupChart();
    }


    private void SetupChart()
    {
        if (!chartReady)
        {
            return;
        }

        if (chartConfig.Data.Datasets.Count > 0)
        {
            chartConfig.RemoveDatasets(chartConfig.Data.Datasets);
        }

        if (chartConfig.Options?.Plugins?.Title != null)
        {
            chartConfig.Options.Plugins.Title.Text = new IndexableOption<string>($"Ratings {RatingDetails.RatingType}");
            chartConfig.UpdateChartOptions();
        }

        (var ratingsData, var gamesData) = GetChartData(RatingDetails.Ratings);
        chartConfig.SetLabels(ratingsData.Select(s => s.X).ToList());

        var lineDataset = GetLineDataset(ratingsData);
        var countDataset = GetCountDataset(gamesData);

        chartConfig.AddDatasets(new List<ChartJsDataset>()
        {
            lineDataset,
            countDataset,
        });
    }

    private (List<ChartRatingData>, List<ChartGamesData>) GetChartData(List<RatingAtDateTime> chartDtos)
    {
        var ratingData = chartDtos
            .Select(s => new
            {
                Date = GetDate(s.Year, s.Week),
                Rating = s.Rating
            })
            .OrderBy(o => o.Date)
            .Select(o => new ChartRatingData
            {
                X = o.Date.ToString("yyyy-MM-dd"),
                Y = o.Rating
            })
            .ToList();

        var gamesData = chartDtos
            .Select(s => new
            {
                Date = GetDate(s.Year, s.Week),
                Games = s.Games
            })
            .OrderBy(o => o.Date)
            .Select(o => new ChartGamesData
            {
                X = o.Date.ToString("yyyy-MM-dd"),
                Y = o.Games
            })
            .ToList();

        return (ratingData, gamesData);
    }

    private static DateTime GetDate(int year, int week)
    {
        DateTime date = new DateTime(year, 1, 1);

        int dayOfWeek = (int)date.DayOfWeek;
        int daysUntilMonday = (dayOfWeek == 0) ? 1 : 8 - dayOfWeek;
        DateTime firstMonday = date.AddDays(daysUntilMonday);

        return firstMonday.AddDays((week - 1) * 7);
    }

    private static string GetDateString(int year, int week)
    {
        DateTime date = new DateTime(year, 1, 1);

        int dayOfWeek = (int)date.DayOfWeek;
        int daysUntilMonday = (dayOfWeek == 0) ? 1 : 8 - dayOfWeek;
        DateTime firstMonday = date.AddDays(daysUntilMonday);

        DateTime weekStartDate = firstMonday.AddDays((week - 1) * 7);

        return weekStartDate.ToString("yyyy-MM-dd");
    }

    private LineDataset GetLineDataset(List<ChartRatingData> data)
    {
        return new()
        {
            Label = "Rating",
            Data = data.Cast<object>().ToList(),
            BackgroundColor = "#4E58A0",
            BorderColor = "#4E58A0",
            BorderWidth = 4,
            Fill = false,
            PointBackgroundColor = new IndexableOption<string>("blue"),
            PointBorderColor = new IndexableOption<string>("blue"),
            PointRadius = new IndexableOption<double>(0),
            PointBorderWidth = new IndexableOption<double>(0),
            PointHitRadius = new IndexableOption<double>(1),
            Tension = 0.2,
            YAxisID = "y"
        };
    }

    private LineDataset GetCountDataset(List<ChartGamesData> data)
    {
        return new()
        {
            Label = "Games",
            Data = data.Cast<object>().ToList(),
            BackgroundColor = "grey",
            BorderColor = "grey",
            BorderWidth = 2,
            Fill = false,
            PointBackgroundColor = new IndexableOption<string>("grey"),
            PointBorderColor = new IndexableOption<string>("grey"),
            PointRadius = new IndexableOption<double>(0),
            PointBorderWidth = new IndexableOption<double>(0),
            PointHitRadius = new IndexableOption<double>(1),
            Tension = 0,
            YAxisID = "y1"
        };
    }

    private async Task<bool> RegisterPlugin()
    {
        if (!isRegistered)
        {
            var module = await moduleTask.Value.ConfigureAwait(false);
            await module.InvokeVoidAsync("registerPlugin")
                .ConfigureAwait(false);

            isRegistered = true;

            if (chartConfig.Options?.Scales?.X != null)
            {
                chartConfig.Options.Scales.X = new TimeCartesianAxis()
                {
                    Display = true,
                    Position = "bottom",
                    Type = "time",
                    Time = new TimeCartesianAxisTime()
                    {
                        Unit = "week",
                        DisplayFormats = new { Week = "yyyy-MM" }
                    },
                    Ticks = new TimeCartesianAxisTicks()
                    {
                        Color = "lightgrey",
                        Padding = 3,
                        AutoSkipPadding = 3,
                        BackdropColor = "rgba(255, 255, 255, 0.75)",
                        ShowLabelBackdrop = false,
                        BackdropPadding = new Padding(2)
                    },
                    Grid = new ChartJsGrid()
                    {
                        Display = true,
                        Color = "#6B6B6B",
                        LineWidth = 1,
                        DrawOnChartArea = true,
                        TickLength = 8,
                        TickWidth = 1,
                        TickColor = "#4E58A0",
                        Offset = false,
                    },
                    Border = new ChartJsAxisBorder()
                    {
                        Display = true,
                        Width = 1,
                        Color = "#6B6B6B"
                    }
                };
            }
            chartConfig.ReinitializeChart();
            return true;
        }
        return false;
    }

    private ChartJsConfig GetLineChartConfig()
    {
        var config = new ChartJsConfig()
        {
            Type = ChartType.line,
            Data = new ChartJsData()
            {
                Labels = new List<string>()
                {
                },
                Datasets = new List<ChartJsDataset>()
                {
                }
            },
            Options = new ChartJsOptions()
            {
                Responsive = true,
                MaintainAspectRatio = true,
                Plugins = new Plugins()
                {
                    ArbitraryLines = new List<ArbitraryLineConfig>(),
                    Title = new Title()
                    {
                        Display = true,
                        Text = new IndexableOption<string>($"Ratings {RatingDetails.RatingType}"),
                        Color = "#4E58A0",
                        Font = new Font()
                        {
                            Size = 16,
                        }
                    }
                },
                Interaction = new Interactions()
                {
                    Intersect = false,
                    Mode = "index"
                },
                Scales = new ChartJsOptionsScales()
                {
                    X = new LinearAxis()
                    {
                        Display = true,
                        Position = "bottom",
                        Ticks = new LinearAxisTick()
                        {
                            Color = "lightgrey",
                            Padding = 3,
                            AutoSkipPadding = 3,
                            BackdropColor = "rgba(255, 255, 255, 0.75)",
                            Align = "center",
                            CrossAlign = "near",
                            ShowLabelBackdrop = false,
                            BackdropPadding = new Padding(2)
                        },
                        Grid = new ChartJsGrid()
                        {
                            Display = true,
                            Color = "#6B6B6B",
                            LineWidth = 1,
                            DrawOnChartArea = true,
                            TickLength = 8,
                            TickWidth = 1,
                            TickColor = "#4E58A0",
                            Offset = false,
                        },
                        Border = new ChartJsAxisBorder()
                        {
                            Display = true,
                            Width = 1,
                            Color = "#6B6B6B"
                        }
                    },
                    Y = new LinearAxis()
                    {
                        Display = true,
                        Type = "linear",
                        Position = "left",
                        Ticks = new LinearAxisTick()
                        {
                            Color = "#4E58A0",
                            Padding = 3,
                            AutoSkipPadding = 3,
                            BackdropColor = "rgba(255, 255, 255, 0.75)",
                            Align = "center",
                            CrossAlign = "near",
                            ShowLabelBackdrop = false,
                            BackdropPadding = new Padding(2)
                        },
                        Grid = new ChartJsGrid()
                        {
                            Display = true,
                            Color = "#6B6B6B",
                            LineWidth = 1,
                            DrawOnChartArea = true,
                            TickLength = 8,
                            TickWidth = 1,
                            TickColor = "#4E58A0",
                            Offset = false,
                        },
                        Border = new ChartJsAxisBorder()
                        {
                            Display = true,
                            Width = 1,
                            Color = "#6B6B6B"
                        }
                    },
                    Y1 = new LinearAxis()
                    {
                        Display = true,
                        Type = "linear",
                        Position = "right",
                        Ticks = new LinearAxisTick()
                        {
                            Color = "grey",
                            Padding = 3,
                            Precision = 0,
                            AutoSkipPadding = 3,
                            BackdropColor = "rgba(255, 255, 255, 0.75)",
                            Align = "center",
                            CrossAlign = "near",
                            ShowLabelBackdrop = false,
                            BackdropPadding = new Padding(2)
                        },
                        Grid = new ChartJsGrid()
                        {
                            DrawOnChartArea = false
                        }
                    }
                }
            }
        };
        return config;
    }

    public void Dispose()
    {
        if (moduleTask.IsValueCreated)
        {
            moduleTask.Value.Dispose();
        }
    }

    private record ChartRatingData
    {
        public string X { get; set; } = string.Empty;
        public float Y { get; set; }
    }

    private record ChartGamesData
    {
        public string X { get; set; } = string.Empty;
        public int Y { get; set; }
    }
}
