@using Microsoft.AspNetCore.Components.Forms
@using dsstats.shared
@implements IDisposable

<div class="bgchart border rounded p-2">
    <EditForm EditContext="editContext" FormName="StatsRequest">
        <div class="row">
            <div class="col-12 col-md-1 align-self-center">
                @if (IsLoading)
                {
                    <div class="spinner-border ms-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                }
                else
                {
                    <span class="bi bi-bar-chart-line ms-2"></span>
                }
            </div>
            <div class="col-auto align-self-center">
                @if (Request.Filter == null)
                {
                    <span class="pointer" @onclick="ShowFilter">
                        <i class="ms-2 text-muted bi bi-filter-circle"></i>
                        <span class="ms-1 text-muted">Filter</span>
                    </span>
                }
                else
                {
                    <span class="pointer" @onclick="ShowFilter">
                        <i class="ms-2 text-primary bi bi-filter-circle-fill"></i>
                        <span class="ms-1 text-primary">Filter</span>
                    </span>
                }
            </div>
            <div class="col-12 col-md-3">
                <label for="timeselect" class="col-form-label">Time Period</label>
                <InputSelect id="timeselect" class="form-select" @bind-Value="Request.TimePeriod">
                    @foreach (TimePeriod type in Enum.GetValues(typeof(TimePeriod)))
                    {
                        @if (type == TimePeriod.None)
                        {
                            <option value="@type">All</option>
                        }
                        else if (type == TimePeriod.Custom)
                        {
                            continue;
                        }
                        else
                        {
                            <option value="@type">@Data.GetTimePeriodInfo(type).Name</option>
                        }
                    }
                </InputSelect>
            </div>
            <div class="col-12 col-md-3">
                <label for="ratingselect" class="col-form-label">Rating Type</label>
                <InputSelect id="ratingselect" class="form-select" @bind-Value="Request.RatingType">
                    @foreach (RatingType type in Enum.GetValues(typeof(RatingType)))
                    {
                        <option value="@type">@type</option>
                    }
                </InputSelect>
            </div>
            <div class="col-12 col-md-3">
                <label for="cmdrselect" class="col-form-label">Commander</label>
                <InputSelect id="cmdrselect" class="form-select" @bind-Value="Request.Interest">
                    @foreach (Commander type in Enum.GetValues(typeof(Commander)))
                    {
                        <option value="@type">@type</option>
                    }
                </InputSelect>
            </div>
            <div class="col-12 col-md-2 form-check form-switch align-self-end mb-2">
                <InputCheckbox class="form-check-input" type="checkbox" role="switch" id="leaverCheck" @bind-Value="Request.WithLeavers" />
                <label class="form-check-label" for="leaverCheck">With Leavers</label>
            </div>
        </div>
    </EditForm>
</div>

<StatsFilterModal @ref="statsFilterModal" OnRequest="FilterRequest" />

@code {
    [Parameter, EditorRequired]
    public StatsRequest Request { get; set; } = default!;

    [Parameter, EditorRequired]
    public bool IsLoading { get; set; }

    [Parameter]
    public EventCallback OnRequestChanged { get; set; }

    EditContext editContext = null!;
    StatsFilterModal? statsFilterModal;

    protected override void OnInitialized()
    {
        editContext = new(Request);
        editContext.OnFieldChanged += FieldChanged;
        base.OnInitialized();
    }

    private void FieldChanged(object? sender, FieldChangedEventArgs e)
    {
        if (!IsLoading)
        {
            OnRequestChanged.InvokeAsync();
        }
    }

    private void ShowFilter()
    {
        if (Request.Filter == null)
        {
            Request.Filter = new();
        }
        statsFilterModal?.Show(Request.Filter);
    }

    private void FilterRequest(StatsFilter? filter)
    {
        Request.Filter = filter;
        OnRequestChanged.InvokeAsync();
    }

    public void Dispose()
    {
        editContext.OnFieldChanged -= FieldChanged;
    }
}
