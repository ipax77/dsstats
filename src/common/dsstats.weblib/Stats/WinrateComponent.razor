@using dsstats.shared
@using dsstats.shared.Interfaces

@inject IStatsService StatsService

<div class="mb-1" style="max-width: 1000px;">
	<StatsRequestComponent @ref="statsRequestComponent" Request="statsRequest" IsLoading="isLoading" OnRequestChanged="Update" />
</div>
@if (response != null)
{
	<div class="row">
		<div class="col-auto">
			@if (response != null)
			{
				<div class="border rounded border-secondary bgchart"
					 style="min-width: 850px; width: 55vw; height: calc(55vw * 0.5); min-height: 425px;">
					<WinrateChart @ref="winrateChart" Request="statsRequest" Response="response"></WinrateChart>
				</div>
			}
		</div>
		<div class="col-auto table-responsive" style="max-height: 70vh; max-width: 400px;">
			<table class="tptable w-auto">
				<thead class="user-select-none">
					<tr>
						<th>Commander</th>
						<th>Games</th>
						<th>AvgPerf</th>
						<th>Winrate</th>
					</tr>
				</thead>
				<tbody class="text-nowrap">
					@if (response != null)
					{
						@foreach (var ent in response.WinrateEnts
										.OrderByDescending(o => o.AvgPerformance))
						{
							<tr>
								<td>
									<div class="d-flex">
										<div class="preload-@(ent.Commander.ToString().ToLower())" alt="@ent.Commander" style="width: 30px; height: 30px;"></div>
										<span>@ent.Commander</span>
									</div>
								</td>
								<td>@Data.GetNumberString(ent.Count)</td>
								<td>
									<span class="@(ent.AvgPerformance < 0 ? "text-danger" : "text-success")">@ent.AvgPerformance</span>
								</td>
								<td>
									@((ent.Count == 0 ? 0 : ent.Wins / (double)ent.Count).ToString("P1"))
								</td>
							</tr>
						}
					}
				</tbody>
			</table>
		</div>
	</div>

}

@code {
	StatsRequest statsRequest = new()
	{
		Type = StatsType.Winrate,
		TimePeriod = TimePeriod.Last90Days,
		RatingType = RatingType.Commanders,
		WithLeavers = false,
	};
	WinrateResponse? response;
	WinrateChart? winrateChart;
	StatsRequestComponent? statsRequestComponent;
	bool isLoading = true;

	protected override void OnInitialized()
	{
		_ = LoadData();
		base.OnInitialized();
	}

	private async Task LoadData()
	{
		try
		{
			response = await StatsService.GetStatsAsync<WinrateResponse>(StatsType.Winrate, statsRequest);
		}
		catch
		{
		}
		finally
		{
			isLoading = false;
			await InvokeAsync(StateHasChanged);
			if (response != null)
			{
				winrateChart?.PrepareData(response, statsRequest);
			}
		}
	}

	private async Task Update()
	{
		isLoading = true;
		await InvokeAsync(StateHasChanged);
		response = await StatsService.GetStatsAsync<WinrateResponse>(StatsType.Winrate, statsRequest);
		winrateChart?.PrepareData(response, statsRequest);
		isLoading = false;
		await InvokeAsync(StateHasChanged);
	}
}
