@page "/ratings"
@using pax.dsstats.dbng.Services
@inject MmrService MmrService
@inject FireMmrService FireMmrService
@implements IDisposable

<div class="d-flex mb-2">
    <div class="btn-group">
        <button class="btn btn-sm btn-primary" @onclick="Recalculate">(Re-)Calculate Ratings</button>
        <button class="btn btn-sm btn-primary" @onclick="RecalculateFire">(Re-)Calculate Ratings with Fire</button>
    </div>
    @if (isLoading)
    {
        <div class="spinner-border text-danger" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    }
    else
    {

    }
</div>
<div>
    <sc2dsstats.razorlib.PlayerRatings @ref="playerRatings"></sc2dsstats.razorlib.PlayerRatings>
</div>
@code {
    private sc2dsstats.razorlib.PlayerRatings? playerRatings;
    private bool isLoading = false;
    private readonly object lockobject = new();

    protected override void OnInitialized()
    {
        MmrService.Recalculated += MmrService_Recalculated;
        base.OnInitialized();
    }

    private async void Recalculate()
    {
        lock (lockobject)
        {
            if (isLoading)
            {
                return;
            }
            isLoading = true;
        }

        // ???
        await Task.Run(async () =>
        {
            await MmrService.CalcMmmr().ConfigureAwait(false);
        });

        isLoading = false;
        
        await InvokeAsync(() => StateHasChanged());
    }

    private async void RecalculateFire()
    {
        lock (lockobject)
        {
            if (isLoading)
            {
                return;
            }
            isLoading = true;
        }

        // ???
        await Task.Run(async () =>
        {
            await FireMmrService.CalcMmmr().ConfigureAwait(false);
        });

        isLoading = false;

        await InvokeAsync(() => StateHasChanged());

        if (playerRatings != null)
        {
            await playerRatings.Reload();
        }
    }

    private async void MmrService_Recalculated(object? sender, EventArgs e)
    {
        if (playerRatings != null)
        {
            await playerRatings.Reload();
        }
        isLoading = false;
    }

    public void Dispose()
    {
        MmrService.Recalculated -= MmrService_Recalculated;
    }
}
